<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Route Rules :: Istio Tutorial Docs</title>
    <link rel="canonical" href="http://localhost/istio-tutorial/0.0.1/5advanced-routerules.html">
    <meta name="generator" content="Antora 1.0.3">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">istio-tutorial</a>
        <span class="separator">//</span>
        <a href="http://localhost">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href=".">istio-tutorial Repository</a>
            <a class="navbar-item" href="./issues">istio-tutorial Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="istio-tutorial" data-version="0.0.1">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Istio Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#minishift">Setup MiniShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#environment">Setup Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#istioinstallation">Install Istio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#redeployingcode">Updating Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="3monitoring-tracing.html">3. Monitoring and Tracing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3monitoring-tracing.html#monitoring">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3monitoring-tracing.html#custommetrics">Custom Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3monitoring-tracing.html#tracing">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="4simple-routerules.html">4. Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4simple-routerules.html#deployrecommendationv2">Create Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="5advanced-routerules.html">5. Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#accesscontrol">Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#whitelist">White List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#blacklist">Black List</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#loadbalancer">Load Balancer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ratelimiting">Rate Limiting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="6fault-injection.html">6. Fault Injection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#delay">Delay</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#timeout">Timeout</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="7circuit-breaker.html">7. Circuit Breaker</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="7circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="7circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="7circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="7circuit-breaker.html#poolejection">Pool Ejection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="7circuit-breaker.html#nofailinginstances">No Failing Instance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="7circuit-breaker.html#failinginstancesnopoolejection">Failing Instance No Pool Ejection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="7circuit-breaker.html#failinginstancespoolejection">Failing Instance Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="7circuit-breaker.html#circuitbreakerandpoolejection">Circuit Breaker + Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="8egress.html">8. Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="9tips.html">9. Tips</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="advanced/index.html">Advanced Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="advanced/kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#installkiali">Install Kiali</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="advanced/virtualization.html">Service Virtualization and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/virtualization.html#servicevirtualization">Adding Service Virtualization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/virtualization.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="advanced/mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/mTLS.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/mTLS.html#enablingtls">Enabling TLS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanced/mTLS.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Istio Tutorial</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Istio Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Istio Tutorial</a></li>
    <li class="crumb"><a href="5advanced-routerules.html">5. Advanced Routing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/alex/git/istio-tutorial/docs/modules/ROOT/pages/5advanced-routerules.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Advanced Route Rules</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>istioctl get virtualservice</code> <code>istioctl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="canarydeploymentuseragent"><a class="anchor" href="#canarydeploymentuseragent"></a>Smart routing based on user-agent header (Canary Deployment)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What is your user-agent?</p>
</div>
<div class="paragraph">
<p><a href="https://www.whoishostingthis.com/tools/user-agent/">https://www.whoishostingthis.com/tools/user-agent/</a></p>
</div>
<div class="paragraph">
<p>Note: the "user-agent" header is added to OpenTracing baggage in the Customer service. From
there it is automatically propagated to all downstream services. To enable automatic
baggage propagation all intermediate services have to be instrumented with OpenTracing.
The baggage header for user agent has following form <code>baggage-user-agent: &lt;value&gt;</code>.</p>
</div>
<div class="sect2">
<h3 id="alltorecommendationv1"><a class="anchor" href="#alltorecommendationv1"></a>Set recommendation to all v1</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial
istioctl create -f istiofiles/virtual-service-recommendation-v1.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="safaritov2"><a class="anchor" href="#safaritov2"></a>Set Safari users to v2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f istiofiles/virtual-service-safari-recommendation-v2.yml -n tutorial

istioctl get virtualservice -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>and test with a Safari (or even Chrome on Mac since it includes Safari in the string). Safari only sees v2 responses from recommendation</p>
</div>
<div class="paragraph">
<p>and test with a Firefox browser, it should only see v1 responses from recommendation.</p>
</div>
<div class="paragraph">
<p>There are two ways to get the URL for your browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minishift openshift service customer --in-browser</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will open the openshift service <code>customer</code> in browser</p>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="paragraph">
<p>if you need just the url alone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minishift openshift service customer --url
http://customer-tutorial.192.168.99.102.nip.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also attempt to use the curl -A command to test with different user-agent strings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -A Safari customer-tutorial.$(minishift ip).nip.io
curl -A Firefox customer-tutorial.$(minishift ip).nip.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can describe the virtualservice to see its configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl get virtualservice -o yaml -n tutorial</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_remove_the_safari_rule"><a class="anchor" href="#_remove_the_safari_rule"></a>Remove the Safari rule</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/virtual-service-safari-recommendation-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mobiletov2"><a class="anchor" href="#mobiletov2"></a>Set mobile users to v2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/virtual-service-mobile-recommendation-v2.yml -n tutorial

curl -A "Mozilla/5.0 (iPhone; U; CPU iPhone OS 4(KHTML, like Gecko) Version/5.0.2 Mobile/8J2 Safari/6533.18.5" customer-tutorial.$(minishift ip).nip.io</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial
istioctl delete -f istiofiles/virtual-service-mobile-recommendation-v2.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>or you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mirroringtraffic"><a class="anchor" href="#mirroringtraffic"></a>Mirroring Traffic (Dark Launch)</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -l app=recommendation -n tutorial
or
kubectl get pods -l app=recommendation -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have 2 pods for recommendation based on the steps above</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl get virtualservice -n tutorial
istioctl get destinationrule</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>istioctl get virtualservice</code> <code>istioctl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you are in the main directory of "istio-tutorial"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial
istioctl create -f istiofiles/virtual-service-recommendation-v1-mirror-v2.yml -n tutorial

curl customer-tutorial.$(minishift ip).nip.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the logs of recommendation-v2</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-v2|awk '{ print $1 }'` -c recommendation
or
kubectl logs -f `oc get pods|grep recommendation-v2|awk '{ print $1 }'` -c recommendation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clean up</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial
istioctl delete -f istiofiles/virtual-service-recommendation-v1-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>or you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accesscontrol"><a class="anchor" href="#accesscontrol"></a>Access Control</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Access Control rules take some time to be applied and reflected. Be patient here!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="whitelist"><a class="anchor" href="#whitelist"></a>Whitelist</h3>
<div class="paragraph">
<p>We&#8217;ll create a whitelist on the preference service to only allow requests from the recommendation service, which will make the preference service invisible to the customer service. Requests from the customer service to the preference service will return a 404 Not Found HTTP error code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/acl-whitelist.yml -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; 404 NOT_FOUND:preferencewhitelist.listchecker.tutorial:customer is not whitelisted</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_2"><a class="anchor" href="#_clean_up_2"></a>Clean up</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/acl-whitelist.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blacklist"><a class="anchor" href="#blacklist"></a>Blacklist</h3>
<div class="paragraph">
<p>We&#8217;ll create a blacklist making the customer service blacklist to the preference service. Requests from the customer service to the preference service will return a 403 Forbidden HTTP error code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/acl-blacklist.yml -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; 403 PERMISSION_DENIED:denycustomerhandler.denier.tutorial:Not allowed</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_3"><a class="anchor" href="#_clean_up_3"></a>Clean up</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/acl-blacklist.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="loadbalancer"><a class="anchor" href="#loadbalancer"></a>Load Balancer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, you will see "round-robin" style load-balancing, but you can change it up, with the RANDOM option being fairly visible to the naked eye.</p>
</div>
<div class="paragraph">
<p>Add another v2 pod to the mix</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale deployment recommendation-v2 --replicas=2 -n tutorial
or
kubectl scale deployment recommendation-v2 --replicas=2 -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a bit (oc get pods -w to watch)
and curl the customer endpoint many times</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a 3rd v2 pod to the mix</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc scale deployment recommendation-v2 --replicas=3 -n tutorial
$ oc get pods -n tutorial

or

$ kubectl scale deployment recommendation-v2 --replicas=3 -n tutorial
$ kubectl get pods -n tutorial


NAME                                  READY     STATUS    RESTARTS   AGE
customer-1755156816-cjd2z             2/2       Running   0          1h
preference-3336288630-2cc6f          2/2       Running   0          1h
recommendation-v1-3719512284-bn42p   2/2       Running   0          59m
recommendation-v2-2815683430-97nnf   2/2       Running   0          43m
recommendation-v2-2815683430-d49n6   2/2       Running   0          51m
recommendation-v2-2815683430-tptf2   2/2       Running   0          33m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for those 2/2 (two containers in each pod) and then poll the customer endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The results should follow a fairly normal round-robin distribution pattern</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1145
customer =&gt; preference =&gt; recommendation v2 from '2819441432-525lh': 1
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 2
customer =&gt; preference =&gt; recommendation v2 from '2819441432-bs5ck': 181
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1146
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 3
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 4
customer =&gt; preference =&gt; recommendation v2 from '2819441432-bs5ck': 182</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, add the Random LB DestinationPolicy</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/destination-rule-recommendation_lb_policy_app.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should see a different pattern of which pod is being selected</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 10
customer =&gt; preference =&gt; recommendation v2 from '2819441432-525lh': 3
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 11
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1153
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1154
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1155
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 12
customer =&gt; preference =&gt; recommendation v2 from '2819441432-525lh': 4
customer =&gt; preference =&gt; recommendation v2 from '2819441432-525lh': 5
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 13
customer =&gt; preference =&gt; recommendation v2 from '2819441432-rg45q': 14</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clean up</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/destination-rule-recommendation_lb_policy_app.yml -n tutorial

oc scale deployment recommendation-v2 --replicas=1 -n tutorial
or
kubectl scale deployment recommendation-v2 --replicas=1 -n tutorial</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ratelimiting"><a class="anchor" href="#ratelimiting"></a>Rate Limiting</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Rate Limiting rules take some time to be applied and reflected. Be patient here!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we will limit the number of concurrent requests into recommendation v2</p>
</div>
<div class="paragraph">
<p>Now apply the rate limit handler</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/recommendation_rate_limit_handler.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now setup the requestcount quota</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f istiofiles/rate_limit_rule.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Throw some requests at customer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see some 429 errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v2 from '2819441432-f4ls5': 108
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1932
customer =&gt; preference =&gt; recommendation v2 from '2819441432-f4ls5': 109
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1933
customer =&gt; 503 preference =&gt; 429 RESOURCE_EXHAUSTED:Quota is exhausted for: RequestCount
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1934
customer =&gt; preference =&gt; recommendation v2 from '2819441432-f4ls5': 110
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1935
customer =&gt; 503 preference =&gt; 429 RESOURCE_EXHAUSTED:Quota is exhausted for: RequestCount
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1936
customer =&gt; preference =&gt; recommendation v2 from '2819441432-f4ls5': 111
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1937
customer =&gt; 503 preference =&gt; 429 RESOURCE_EXHAUSTED:Quota is exhausted for: RequestCount
customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 1938
customer =&gt; preference =&gt; recommendation v2 from '2819441432-f4ls5': 112</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clean up</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl delete -f istiofiles/rate_limit_rule.yml

istioctl delete -f istiofiles/recommendation_rate_limit_handler.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>or you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
